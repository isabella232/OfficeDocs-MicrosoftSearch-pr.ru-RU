---
title: Агент локального
ms.author: rusamai
author: rsamai
manager: jameslau
audience: Admin
ms.audience: Admin
ms.topic: article
ms.service: mssearch
localization_priority: Normal
search.appverid:
- BFB160
- MET150
- MOE150
ROBOTS: NoIndex
description: Агент on-prem
ms.openlocfilehash: 1fcd1b6848d950c9f7cefa87d086f6607ac5df4f
ms.sourcegitcommit: 5151bcd8fd929ef37239b7c229e2fa33b1e0e0b7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/13/2021
ms.locfileid: "58235943"
---
# <a name="microsoft-graph-connector-agent"></a>Агент соедините Graph Microsoft

Для установки программного обеспечения агента соединительных агентов Microsoft Graph предварительного *подключения.* Это позволяет безопасно передавать данные между локальной передачей данных и API соединители. В этой статье вы можете с помощью установки и настройки агента.

## <a name="installation"></a>Установка

Скачайте последнюю версию агента Graph соединителя и установите программное обеспечение [https://aka.ms/GCAdownload](https://aka.ms/gcadownload) с помощью мастера установки. С помощью рекомендуемой конфигурации машины, описанной ниже, программное обеспечение может обрабатывать до трех подключений. Любые подключения за пределами этого могут привести к ухудшению производительности всех подключений агента.

Рекомендуемая конфигурация:

* Windows 10, Windows Server 2016 R2 и выше
* [.NET Core Desktop Runtime 3.1 (x64)](https://dotnet.microsoft.com/download/dotnet-core/3.1)
* 8 ядер, 3 ГГц
* 16 ГБ оперативной памяти, 2 ГБ дискового пространства
* Сетевой доступ к источнику данных и Интернету через 443

После установки агента, если прокси-серверы или брандмауэры вашей организации блокируют связь с неизвестными доменами, добавьте ниже их в список допустимых.

1. *.servicebus.windows.net
2. *.events.data.microsoft.com
3. https://<span>login.microsoftonline.</span> com
4. https://<span>gcs.office.</span> com/
5. https://<span>graph.microsoft.</span> com/


## <a name="create-and-configure-an-app-for-the-agent"></a>Создание и настройка приложения для агента  

Во-первых, впишитесь и обратите внимание, что минимальная необходимая привилегия для учетной записи — администратор поиска. Затем агент попросит вас предоставить сведения о проверке подлинности. Используйте ниже шаги для создания приложения и создания необходимых сведений о проверке подлинности.

### <a name="create-an-app"></a>Создать приложение

1. Перейдите на [портал Azure и](https://portal.azure.com) войдите с учетными данными администратора для клиента.

2. Перейдите **Azure Active Directory** регистрации приложений из области навигации и  ->   выберите **новую регистрацию.**

3. Укай имя приложения и выберите **Register.**

4. Обратите внимание на ID приложения (клиента).

5. Откройте **разрешения API из** области навигации и выберите Добавить **разрешение.**

6. Выберите **microsoft Graph,** а затем **разрешения приложения**.

7. Поиск "ExternalItem.ReadWrite.All" и "Directory.Read.All" из разрешений и выберите **Добавить разрешения**.

8. Выберите **согласие администратора гранта для [TenantName]** и подтвердит, выбрав **Да**.

9. Убедитесь, что разрешения находятся в состоянии "предоставлено".

    :::image type="content" alt-text="Разрешения, показанные в зеленом цвете в правой колонке." source="media/onprem-agent/granted-state.png" lightbox="media/onprem-agent/granted-state.png":::

### <a name="configure-authentication"></a>Настроить аутентификацию

Сведения о проверке подлинности можно предоставлять с помощью клиентской тайны или сертификата. Следуйте шагам по вашему выбору.

#### <a name="configuring-the-client-secret-for-authentication"></a>Настройка секрета клиента для проверки подлинности

1. Перейдите на [портал Azure и](https://portal.azure.com) войдите с учетными данными администратора для клиента.

2. Откройте **регистрацию приложения** из области навигации и перейдите к соответствующему приложению. В **статье Управление** выберите **сертификаты и секреты.**

3. Выберите **секрет "Новый клиент"** и выберите для этого секрета период истечения срока действия. Скопируйте созданный секрет и сохраните его, так как он больше не будет показан.

4. Используйте этот секрет клиента вместе с ИД приложения для настройки агента. В поле **Имя** агента нельзя использовать пустые пробелы. Принимаются числимые символы Альфа.

#### <a name="using-a-certificate-for-authentication"></a>Использование сертификата для проверки подлинности

Существует три простых шага для использования проверки подлинности на основе сертификатов:

1. Создание или получение сертификата
2. Upload сертификат на портал Azure
3. Назначение сертификата агенту

##### <a name="step-1-get-a-certificate"></a>Шаг 1. Получить сертификат

Сценарий ниже можно использовать для создания самозаверяемого сертификата. В организации могут не разрешаться самозаверяться сертификаты. В этом случае используйте эти сведения для понимания требований и получения сертификата в соответствии с политиками организации.

```powershell
$dnsName = "<TenantDomain like agent.onmicrosoft.com>" # Your DNS name
$password = "<password>" # Certificate password
$folderPath = "D:\New folder\" # Where do you want the files to get saved to? The folder needs to exist.
$fileName = "agentcert" # What do you want to call the cert files? without the file extension
$yearsValid = 10 # Number of years until you need to renew the certificate
$certStoreLocation = "cert:\LocalMachine\My"
$expirationDate = (Get-Date).AddYears($yearsValid)
$certificate = New-SelfSignedCertificate -DnsName $dnsName -CertStoreLocation $certStoreLocation -NotAfter $expirationDate -KeyExportPolicy Exportable -KeySpec Signature
$certificatePath = $certStoreLocation + '\' + $certificate.Thumbprint
$filePath = $folderPath + '\' + $fileName
$securePassword = ConvertTo-SecureString -String $password -Force -AsPlainText
Export-Certificate -Cert $certificatePath -FilePath ($filePath + '.cer')
Export-PfxCertificate -Cert $certificatePath -FilePath ($filePath + '.pfx') -Password $securePassword
```

##### <a name="step-2-upload-the-certificate-in-the-azure-portal"></a>Шаг 2. Upload сертификат на портале Azure

1. Откройте приложение и перейдите в раздел сертификаты и секреты из левой области.

2. Выберите **Upload сертификат и** загрузите файл .cer.

3. Откройте **регистрацию приложения** и **выберите сертификаты и секреты** из области навигации. Скопируйте отпечатки сертификатов.

:::image type="content" alt-text="Список сертификатов thumbrint при выборе сертификатов и секретов в левой области" source="media/onprem-agent/certificates.png" lightbox="media/onprem-agent/certificates.png":::

##### <a name="step-3-assign-the-certificate-to-the-agent"></a>Шаг 3. Назначение сертификата агенту

Если вы использовали пример сценария для создания сертификата, файл PFX можно найти в расположении, идентифицированного в скрипте.

1. Скачайте файл сертификата pfx на компьютер Agent.

2. Дважды щелкните файл pfx, чтобы запустить диалоговое окно установки сертификата.

3. Выберите **локализованную** машину для расположения магазина при установке сертификата.

4. После установки сертификата откройте **управление сертификатами компьютера** через меню .

5. Выберите недавно установленный сертификат в **личных**  >  **сертификатах.**

6. Щелкните правой кнопкой мыши на сертификате и выберите **параметр "Управление** закрытыми  >  **ключами"** всеми задачами.

7. В диалоговом окантове разрешений выберите параметр добавить. В диалоговом окне выбора пользователя напишите: **NT Service\GcaHostService** и нажмите **кнопку ОК**. Не нажимайте **кнопку Check Names.**

8. Щелкните кнопку окей в диалоговом окантовке разрешений. Машина агента теперь настроена для агента для создания маркеров с помощью сертификата.

## <a name="troubleshooting"></a>Устранение неполадок

### <a name="installation-failure"></a>Сбой установки
Если установка не работает, проверьте журналы установки, запущенные: msiexec /i <path to msi> "\GcaInstaller.msi" /L*V <destination path> "\install.log". Если ошибки не разрешаемы, MicrosoftGraphConnectorsFeedback@service.microsoft.com поддержку с журналами.

### <a name="registration-failure"></a>Сбой регистрации

Если вход для конфигурирования приложения не удается с ошибкой "Вход в не удалось. Нажмите кнопку вход, чтобы попробовать еще раз". даже после успешной проверки подлинности браузера откройте services.msc и проверьте, работает ли GcaHostService. Если это не так, запустите его вручную.

Если служба не может начать работу с ошибкой "Служба не началась из-за сбоя логотипа", проверьте, есть ли у виртуальной учетной записи NT Service\GcaHostService разрешение на вход в качестве службы на компьютере. Проверьте [эту ссылку](/windows/security/threat-protection/security-policy-settings/log-on-as-a-service) для инструкций. Если параметр добавить пользователя или группу серый в назначении прав на локальные политики и права пользователей, это означает, что пользователь, пытающийся добавить эту учетную запись, не имеет привилегий администратора на этом компьютере или что это переопределение групповой политики. Необходимо обновить групповую политику, чтобы разрешить службе хост-службы логотип как службу.

### <a name="connection-failure"></a>Сбой подключения

Если действие "Тестовое подключение" не удается при создании подключения к ошибке "Проверьте имя пользователя/пароль и путь datasource", даже если предоставленное имя пользователя и пароль являются правильными, убедитесь, что учетная запись пользователя имеет интерактивные права на логотип машины, на которой установлен агент Graph соединители. Перенаправление документации по [управлению политиками logon](/windows/security/threat-protection/security-policy-settings/allow-log-on-locally#policy-management) для проверки прав на логотип. Кроме того, убедитесь, что источник данных и машина агента находятся в одной сети.

Если подключение не удается с ошибкой "1011: агент соединиттеля Graph не является недоступным или автономным", войдите в машину, на которой установлен агент, и запустите приложение агента, если оно еще не запущено. Если подключение продолжает сбой, убедитесь, что сертификат или секрет клиента, предоставленный агенту во время регистрации, не истек и имеет необходимые разрешения.
